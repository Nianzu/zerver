<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nico's Nook</title>
    <link rel="stylesheet" href="../homestyles.css">
    <style>
        .saved-feedback {
            display: none;
            color: green;
            margin-left: 10px;
        }

        .file-tree-item {
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .icon {
            margin: 3px;
        }
    </style>
</head>

<body>
    <!-- #include sidebar.html -->

    <div class="file-tree" id="file-tree"></div>
    <script>
        async function loadFolder(path = "") {
            const response = await fetch('/files', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path })
            });

            const files = await response.json();
            const fileTree = document.getElementById('file-tree');
            fileTree.innerHTML = ''; // Clear existing content

            files.forEach(file => {
                const fileElement = document.createElement('div');
                fileElement.setAttribute('class', 'file-tree-item');
                fileElement.textContent = file.name;
                fileElement.onclick = () => {
                    if (file.is_dir) {
                        loadFolder(file.path); // Load child directory
                    } else {
                        loadFile(file.path); // Load file for editing
                    }
                };
                if (file.is_dir) {
                    var img = document.createElement('IMG');
                    img.setAttribute('src', '../folder_w.png');
                    img.setAttribute('style', "width:20px;");
                    img.setAttribute('class', "icon");
                    fileElement.prepend(img);
                }
                fileTree.appendChild(fileElement);
            });
        }

        async function loadFile(path) {
            const response = await fetch('/edit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `path=${encodeURIComponent(path)}`
            });

            if (response.ok) {
                const content = await response.text();
                const textarea = document.querySelector('div[name="content"]');
                textarea.innerText = content;
                const pathTextarea = document.querySelector('textarea[name="path"]');
                pathTextarea.value = path;
            } else {
                alert('Error loading file.');
            }
        }

        async function saveFile(event) {
            event.preventDefault();

            const path = document.querySelector('textarea[name="path"]').value;
            const content = document.querySelector('div[name="content"]').innerText;

            const response = await fetch('/overwrite', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `path=${encodeURIComponent(path)}&content=${encodeURIComponent(content)}`
            });

            const feedback = document.getElementById('saved-feedback');
            if (response.ok) {
                feedback.textContent = 'Saved!';
                feedback.style.display = 'inline';
                setTimeout(() => (feedback.style.display = 'none'), 3000); // Hide after 3 seconds
            } else {
                feedback.textContent = 'Error saving!';
                feedback.style.color = 'red';
                feedback.style.display = 'inline';
                setTimeout(() => (feedback.style.display = 'none'), 3000);
            }
        }

        // Load the root folder on page load
        loadFolder('/');
    </script>

    <div class="content">
        <header>
            <h1>Obsidian</h1>
        </header>


        <form id="save-form">
            <textarea name="path" readonly style="width: 100%; height: 30px;"></textarea>
            <div name="content" contenteditable="true"></div>
            <button type="submit">Save</button>
            <span id="saved-feedback" class="saved-feedback">Saved!</span>
        </form>

        <footer>
            <p>&copy; 2023 Nico Zucca. No rights reserved.</p>
        </footer>
    </div>

    <script>
        // Attach save handler to the form
        document.getElementById('save-form').addEventListener('submit', saveFile);
        document.addEventListener('keydown', e => {
            if (e.ctrlKey && e.key === 's') {
                // Prevent the Save dialog to open
                e.preventDefault();
                
                console.log('CTRL + S');
                saveFile(e);
            }
        });
    </script>
</body>

</html>